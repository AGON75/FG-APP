import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = "https://ckolzmqarfizoxjgolft.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrb2x6bXFhcmZpem94amdvbGZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2Nzg3NTYsImV4cCI6MjA2NTI1NDc1Nn0.ZlpERz1uznM0fn--GR9YgM2vjwe_kw-qiPF8KHJvMpI";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const signupForm = document.getElementById('signup-form');
const resultElem = document.getElementById('result');
const mainStatus = document.getElementById('main-status');
const logoutBtn = document.getElementById('logout-btn');
const refreshBtn = document.getElementById('refresh-btn');
const changerJoueurBtn = document.getElementById('changer-joueur-btn');
const terrainTable = document.getElementById('terrain-table');
const prochainesManches = document.getElementById('prochaines-manches');

let playerId = localStorage.getItem("player_id");
let refreshIntervalId = null;

function showInscription() {
  signupForm.style.display = "";
  logoutBtn.style.display = "none";
  mainStatus.textContent = "Inscris-toi pour participer !";
  terrainTable.style.display = "none";
  prochainesManches.innerHTML = "";
}

function showJoueur(joueur) {
  signupForm.style.display = "none";
  logoutBtn.style.display = "";
  mainStatus.textContent = `Bienvenue ${joueur.name} !`;
  afficherTableauTerrain(joueur.terrain);
  afficherProchainesManches(joueur.id);
}

async function inscrireOuConnecter(name) {
  // Vérifie si le joueur existe déjà
  const { data: existing, error: selectError } = await supabase
    .from('players')
    .select('id, name, terrain')
    .eq('name', name)
    .maybeSingle();

  if (selectError && selectError.code !== 'PGRST116') {
    resultElem.textContent = "❌ " + selectError.message;
    return;
  }
  if (existing) {
    // Connexion
    playerId = existing.id;
    localStorage.setItem("player_id", playerId);
    showJoueur(existing);
    startRefresh();
    return;
  }
  // Inscription
  const { data: inserted, error: insertError } = await supabase
    .from('players')
    .insert([{ name }])
    .select()
    .single();
  if (insertError) {
    resultElem.textContent = "❌ " + insertError.message;
    return;
  }
  playerId = inserted.id;
  localStorage.setItem("player_id", playerId);
  showJoueur(inserted);
  startRefresh();
}

async function getPlayerById(id) {
  const { data } = await supabase
    .from("players")
    .select("*")
    .eq("id", id)
    .single();
  return data;
}

async function afficherTableauTerrain(terrain) {
  if (!terrain) {
    terrainTable.style.display = "none";
    return;
  }
  const { data } = await supabase
    .from("players")
    .select("name, matches, round")
    .eq("terrain", terrain);
  terrainTable.innerHTML = `<tr><th>Nom</th><th>Matchs joués</th><th>Round</th></tr>`;
  for (const p of data) {
    terrainTable.innerHTML += `<tr><td>${p.name}</td><td>${p.matches ?? 0}</td><td>${p.round ?? "-"}</td></tr>`;
  }
  terrainTable.style.display = "table";
}

async function afficherProchainesManches(joueurId) {
  const { data } = await supabase
    .from("matches")
    .select("phase, round, terrain")
    .eq("player_id", joueurId)
    .order("phase", { ascending: true })
    .order("round", { ascending: true });
  let html = "<ul>";
  if (data && data.length > 0) {
    data.forEach(m => {
      html += `<li>${m.phase} - Manche ${m.round} sur piste ${m.terrain}</li>`;
    });
    html += "</ul>";
    prochainesManches.innerHTML = html;
  } else {
    prochainesManches.innerHTML = "<div style='color:#ffd700;font-weight:bold;'>Aucune prochaine manche prévue.</div>";
  }
}

function startRefresh() {
  if (refreshIntervalId) clearInterval(refreshIntervalId);
  if (playerId) {
    refreshIntervalId = setInterval(async () => {
      const joueur = await getPlayerById(playerId);
      if (joueur) showJoueur(joueur);
    }, 10000);
  }
}

signupForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  const nameInput = document.getElementById('name');
  const name = nameInput.value.trim();
  if (!name) {
    resultElem.textContent = "❌ Veuillez entrer un nom.";
    return;
  }
  resultElem.textContent = "⏳ Inscription/connexion en cours...";
  await inscrireOuConnecter(name);
});

logoutBtn.addEventListener('click', () => {
  localStorage.removeItem("player_id");
  if (refreshIntervalId) clearInterval(refreshIntervalId);
  location.reload();
});

changerJoueurBtn.addEventListener('click', () => {
  localStorage.removeItem("player_id");
  if (refreshIntervalId) clearInterval(refreshIntervalId);
  location.reload();
});

refreshBtn.addEventListener('click', async () => {
  if (playerId) {
    const joueur = await getPlayerById(playerId);
    if (joueur) showJoueur(joueur);
  }
});

// Initialisation
(async function () {
  if (!playerId) {
    showInscription();
  } else {
    const joueur = await getPlayerById(playerId);
    if (joueur) {
      showJoueur(joueur);
      startRefresh();
    } else {
      showInscription();
    }
  }
})();
