<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Arbitre ‚Äì Finger Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      background: linear-gradient(to right, #0d47a1, #b71c1c);
      color: white;
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      padding: 20px;
      margin: 0;
    }
    header img {
      width: 200px;
      max-width: 90%;
      margin-top: 20px;
    }
    h1 {
      margin-top: 10px;
    }
    select, button {
      font-size: 16px;
      padding: 10px;
      margin: 10px 5px;
    }
    .player-button {
      display: inline-block;
      margin: 6px;
      padding: 10px 16px;
      border-radius: 6px;
      border: none;
      background: #444;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    .eliminated {
      background-color: #b71c1c !important;
      text-decoration: line-through;
    }
    .score-btn {
      margin-left: 6px;
      font-size: 13px;
      padding: 2px 7px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #ffd700;
      color: #222;
      font-weight: bold;
      vertical-align: middle;
    }
    .score-btn.minus {
      background: #b71c1c;
      color: #fff;
    }
    .score-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient(
      'https://ckolzmqarfizoxjgolft.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrb2x6bXFhcmZpem94amdvbGZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2Nzg3NTYsImV4cCI6MjA2NTI1NDc1Nn0.ZlpERz1uznM0fn--GR9YgM2vjwe_kw-qiPF8KHJvMpI'
    );

    let players = [];
    let eliminatedOrder = [];
    let currentPhase = 1;
    let currentRound = "A";
    let currentTerrain = 1;

    const baremes = {
      4: [20, 10, 0, -5],
      5: [25, 20, 10, 0, -5],
      6: [30, 25, 15, 5, 0, -5],
      7: [30, 25, 20, 15, 10, 0, -5],
      8: [30, 25, 20, 15, 10, 5, 0, -5],
      9: [35, 30, 25, 20, 15, 10, 5, 0, -5],
      10:[40, 35, 30, 25, 20, 15, 10, 5, 0, -5]
    };

    function isFinale() {
      return (
        (currentPhase === 99 && (currentRound === "F" || currentRound === "üèÅ Demi Finale")) ||
        (currentPhase === "finale" && (currentRound === "FM" || currentRound === "üèÅ Grande Finale"))
      );
    }

    async function chargerJoueurs() {
      const phaseValue = document.getElementById("phase").value;
      currentPhase = isNaN(phaseValue) ? phaseValue : parseInt(phaseValue);
      currentRound = document.getElementById("round").value;
      currentTerrain = parseInt(document.getElementById("terrain").value);

      let query = supabase.from("players").select("*").eq("terrain", currentTerrain);

      // ‚úÖ Prise en compte des rounds sp√©ciaux pour les phases sp√©ciales
      if (
        (currentPhase === 99 && (currentRound === "üèÅ Demi Finale" || currentRound === "F")) ||
        (currentPhase === 99 && currentRound === "Demi Finale")
      ) {
        query = query.eq("phase", 99).eq("round", "üèÅ Demi Finale");
      } else if (
        (currentPhase === "finale" && (currentRound === "üèÅ Grande Finale" || currentRound === "FM"))
      ) {
        query = query.eq("phase", "finale").eq("round", "üèÅ Grande Finale");
      } else {
        if (currentPhase === "finale") {
          query = query.eq("phase", "finale").eq("round", currentRound);
        } else {
          query = query.eq("phase", currentPhase).eq("round", currentRound);
        }
      }

      const { data } = await query.order("name");
      players = data;
      eliminatedOrder = [];
      renderPlayers();
    }

    window.ajouterJoueurArbitre = async function() {
      const nom = document.getElementById("ajoutNom").value.trim();
      if (!nom) return alert("Nom requis");
      // G√©n√®re un num√©ro unique comme pour l'inscription
      const { data: existing } = await supabase.from("players").select("id, name").ilike("name", `${nom} #%`);
      let numero = 1;
      if (existing && existing.length > 0) {
        const nums = existing.map(e => {
          const m = e.name.match(/#(\d+)$/);
          return m ? parseInt(m[1], 10) : null;
        }).filter(n => n !== null);
        while (nums.includes(numero)) numero++;
      }
      const fullName = `${nom} #${numero}`;
      let joueur;
      const { data: found } = await supabase.from("players").select("*").eq("name", fullName);
      if (found && found.length > 0) {
        joueur = found[0];
      } else {
        const { data: inserted } = await supabase.from("players").insert({ name: fullName }).select().single();
        joueur = inserted;
      }
      // Affecte √† la phase/round/terrain courants
      await supabase.from("players").update({
        phase: currentPhase,
        round: currentRound,
        terrain: currentTerrain
      }).eq("id", joueur.id);
      document.getElementById("ajoutNom").value = "";
      chargerJoueurs();
    }

    function renderPlayers() {
      const zone = document.getElementById("joueurs");
      zone.innerHTML = "";
      players.forEach(p => {
        const btn = document.createElement("button");
        btn.textContent = p.name;
        btn.className = "player-button";
        let elim = eliminatedOrder.filter(id => id === p.id).length;
        if (elim > 0) {
          btn.classList.add("eliminated");
          btn.textContent += isFinale() ? ` (${elim}/2)` : ` (#${elim})`;
        }
        btn.onclick = () => toggleElimination(p.id);

        // ‚ûï Ajout boutons +10 / -5 avec confirmation
        const plusBtn = document.createElement("button");
        plusBtn.textContent = "+10";
        plusBtn.className = "score-btn";
        plusBtn.title = "Ajouter 10 points";
        plusBtn.onclick = async (e) => {
          e.stopPropagation();
          if (p.total_points === "FINALISTE" || p.total_points === "VAINQUEUR") return;
          if (!confirm("Confirmer l‚Äôajout/retrait de points ?")) return;
          let base = isNaN(parseInt(p.total_points, 10)) ? 0 : parseInt(p.total_points, 10);
          await supabase.from("players").update({ total_points: base + 10 }).eq("id", p.id);
          await chargerJoueurs();
        };
        if (p.total_points === "FINALISTE" || p.total_points === "VAINQUEUR") plusBtn.disabled = true;

        const minusBtn = document.createElement("button");
        minusBtn.textContent = "-5";
        minusBtn.className = "score-btn minus";
        minusBtn.title = "Retirer 5 points";
        minusBtn.onclick = async (e) => {
          e.stopPropagation();
          if (p.total_points === "FINALISTE" || p.total_points === "VAINQUEUR") return;
          if (!confirm("Confirmer l‚Äôajout/retrait de points ?")) return;
          let base = isNaN(parseInt(p.total_points, 10)) ? 0 : parseInt(p.total_points, 10);
          await supabase.from("players").update({ total_points: base - 5 }).eq("id", p.id);
          await chargerJoueurs();
        };
        if (p.total_points === "FINALISTE" || p.total_points === "VAINQUEUR") minusBtn.disabled = true;

        // Ajout bouton ‚ùå pour retirer le joueur de la manche
        const removeBtn = document.createElement("button");
        removeBtn.textContent = "‚ùå";
        removeBtn.className = "score-btn minus";
        removeBtn.title = "Retirer ce joueur de cette manche";
        removeBtn.onclick = async (e) => {
          e.stopPropagation();
          await supabase.from("players").update({ phase: null, round: null, terrain: null }).eq("id", p.id);
          await chargerJoueurs();
        };

        const wrapper = document.createElement("span");
        wrapper.appendChild(btn);
        wrapper.appendChild(plusBtn);
        wrapper.appendChild(minusBtn);
        wrapper.appendChild(removeBtn);

        zone.appendChild(wrapper);
      });
      if (isFinale()) {
        document.getElementById("ordre").textContent = `${eliminatedOrder.length} √©liminations / ${players.length * 2} n√©cessaires`;
      } else {
        document.getElementById("ordre").textContent = `${eliminatedOrder.length} / ${players.length} √©limin√©s`;
      }
    }

    function toggleElimination(id) {
      if (isFinale()) {
        const count = eliminatedOrder.filter(pid => pid === id).length;
        if (count < 2) {
          eliminatedOrder.push(id);
        }
      } else {
        const index = eliminatedOrder.indexOf(id);
        if (index > -1) {
          eliminatedOrder.splice(index, 1);
        } else {
          eliminatedOrder.push(id);
        }
      }
      renderPlayers();
    }

    async function validerManche() {
      // üõë Confirmation avant validation
      if (!confirm("√ätes-vous s√ªr de vouloir valider cette manche ? Cette action est irr√©versible.")) return;

      if (isFinale()) {
        const counts = {};
        players.forEach(p => counts[p.id] = 0);
        eliminatedOrder.forEach(id => counts[id]++);
        const stillIn = Object.entries(counts).filter(([id, c]) => c < 2);
        if (stillIn.length !== 1) {
          alert("‚ö† Il doit rester un seul joueur avec moins de 2 √©liminations.");
          return;
        }
        eliminatedOrder.push(stillIn[0][0]);
      } else {
        if (eliminatedOrder.length !== players.length - 1) {
          alert("‚ö† Il doit rester un seul joueur non √©limin√©.");
          return;
        }
        const winner = players.find(p => !eliminatedOrder.includes(p.id));
        if (winner) eliminatedOrder.push(winner.id);
      }

      const bar√®me = baremes[players.length] || baremes[8];

      for (let i = 0; i < eliminatedOrder.length; i++) {
        const playerId = eliminatedOrder[i];
        const points = bar√®me[i] !== undefined ? bar√®me[i] : 0;

        await supabase.from("eliminations").insert({
          player_id: playerId,
          terrain: currentTerrain,
          rank: i + 1
        });

        const { data } = await supabase.from("players").select("*").eq("id", playerId).single();
        if (data) {
          // Ne pas ajouter de points si le joueur est FINALISTE ou VAINQUEUR
          let newPoints = data.total_points;
          if (data.total_points !== "FINALISTE" && data.total_points !== "VAINQUEUR") {
            const base = isNaN(parseInt(data.total_points, 10)) ? 0 : parseInt(data.total_points, 10);
            newPoints = base + points;
          }
          await supabase.from("players").update({
            total_points: newPoints,
            matches: (parseInt(data.matches, 10) || 0) + 1
          }).eq("id", playerId);
        }
      }

      alert("‚úÖ Manche enregistr√©e !");
      players = [];
      eliminatedOrder = [];
      renderPlayers();
    }

    window.onload = () => {
      const t = document.getElementById("terrain");
      const p = document.getElementById("phase");
      const r = document.getElementById("round");
      for (let i = 1; i <= 5; i++) {
        t.innerHTML += `<option value="${i}">Piste ${i}</option>`;
        p.innerHTML += `<option value="${i}">Phase ${i}</option>`;
      }
      p.innerHTML += `<option value="99">Demi-finale</option>`;
      p.innerHTML += `<option value="finale">Finale manuelle</option>`;
      r.innerHTML += `<option value="C">C</option>`;
      r.innerHTML += `<option value="F">Demi Finale</option>`;
      r.innerHTML += `<option value="FM">Finale du Tournoi</option>`;
      // Ajout des rounds sp√©ciaux pour s√©lection rapide
      r.innerHTML += `<option value="üèÅ Demi Finale">üèÅ Demi Finale</option>`;
      r.innerHTML += `<option value="üèÅ Grande Finale">üèÅ Grande Finale</option>`;
    };

    window.chargerJoueurs = chargerJoueurs;
    window.validerManche = validerManche;
  </script>
</head>
<body>
  <header>
    <img src="../assets/FingerGame_logo_blanc_tagline.png" alt="Finger Game" />
    <h1>üéØ Arbitrage ‚Äì Finger Game</h1>
  </header>

  <div style="margin-bottom:10px;">
    <input id="ajoutNom" placeholder="Nom et pr√©nom" style="padding:6px;">
    <button onclick="ajouterJoueurArbitre()">Ajouter ce joueur √† la manche</button>
  </div>

  <label>Phase :</label>
  <select id="phase"></select>
  <label>Round :</label>
  <select id="round">
    <option value="A">A</option>
    <option value="B">B</option>
  </select>
  <label>Piste :</label>
  <select id="terrain"></select>
  <button onclick="chargerJoueurs()">Charger les joueurs</button>

  <div id="joueurs" style="margin-top: 20px;"></div>
  <p id="ordre"></p>

  <button
