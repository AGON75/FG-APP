<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Arbitre â€“ Finger Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      background: linear-gradient(to right, #0d47a1, #b71c1c);
      color: white;
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      padding: 20px;
      margin: 0;
    }
    header img {
      width: 200px;
      max-width: 90%;
      margin-top: 20px;
    }
    h1 {
      margin-top: 10px;
    }
    select, button {
      font-size: 16px;
      padding: 10px;
      margin: 10px 5px;
    }
    .player-button {
      display: inline-block;
      margin: 6px;
      padding: 10px 16px;
      border-radius: 6px;
      border: none;
      background: #444;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    .eliminated {
      background-color: #b71c1c !important;
      text-decoration: line-through;
    }
  </style>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient(
      'https://ckolzmqarfizoxjgolft.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrb2x6bXFhcmZpem94amdvbGZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2Nzg3NTYsImV4cCI6MjA2NTI1NDc1Nn0.ZlpERz1uznM0fn--GR9YgM2vjwe_kw-qiPF8KHJvMpI'
    );

    let players = [];
    let eliminatedOrder = [];
    let currentPhase = 1;
    let currentRound = "A";
    let currentTerrain = 1;

    const baremes = {
      4: [20, 10, 0, -5],
      5: [25, 20, 10, 0, -5],
      6: [30, 25, 15, 5, 0, -5],
      7: [30, 25, 20, 15, 10, 0, -5],
      8: [30, 25, 20, 15, 10, 5, 0, -5],
      9: [35, 30, 25, 20, 15, 10, 5, 0, -5],
      10:[40, 35, 30, 25, 20, 15, 10, 5, 0, -5]
    };

    // Finale classique ou manuelle
    function isFinale() {
      return (
        (currentPhase === 99 && currentRound === "F") ||
        (currentPhase === "finale" && currentRound === "FM")
      );
    }

    async function chargerJoueurs() {
      const phaseValue = document.getElementById("phase").value;
      currentPhase = isNaN(phaseValue) ? phaseValue : parseInt(phaseValue);
      currentRound = document.getElementById("round").value;
      currentTerrain = parseInt(document.getElementById("terrain").value);

      let query = supabase.from("players").select("*").eq("round", currentRound).eq("terrain", currentTerrain);

      if (currentPhase === "finale") {
        query = query.eq("phase", "finale");
      } else {
        query = query.eq("phase", currentPhase);
      }

      const { data } = await query.order("name");

      players = data;
      eliminatedOrder = [];
      renderPlayers();
    }

    function renderPlayers() {
      const zone = document.getElementById("joueurs");
      zone.innerHTML = "";
      players.forEach(p => {
        const btn = document.createElement("button");
        btn.textContent = p.name;
        btn.className = "player-button";
        let elim = eliminatedOrder.filter(id => id === p.id).length;
        if (elim > 0) {
          btn.classList.add("eliminated");
          btn.textContent += isFinale() ? ` (${elim}/2)` : ` (#${elim})`;
        }
        btn.onclick = () => toggleElimination(p.id);
        zone.appendChild(btn);
      });
      if (isFinale()) {
        document.getElementById("ordre").textContent = `${eliminatedOrder.length} Ã©liminations / ${players.length * 2} nÃ©cessaires`;
      } else {
        document.getElementById("ordre").textContent = `${eliminatedOrder.length} / ${players.length} Ã©liminÃ©s`;
      }
    }

    function toggleElimination(id) {
      if (isFinale()) {
        const count = eliminatedOrder.filter(pid => pid === id).length;
        if (count < 2) {
          eliminatedOrder.push(id);
        }
      } else {
        const index = eliminatedOrder.indexOf(id);
        if (index > -1) {
          eliminatedOrder.splice(index, 1);
        } else {
          eliminatedOrder.push(id);
        }
      }
      renderPlayers();
    }

    async function validerManche() {
      if (isFinale()) {
        const counts = {};
        players.forEach(p => counts[p.id] = 0);
        eliminatedOrder.forEach(id => counts[id]++);
        const stillIn = Object.entries(counts).filter(([id, c]) => c < 2);
        if (stillIn.length !== 1) {
          alert("âš  Il doit rester un seul joueur avec moins de 2 Ã©liminations.");
          return;
        }
        eliminatedOrder.push(stillIn[0][0]);
      } else {
        if (eliminatedOrder.length !== players.length - 1) {
          alert("âš  Il doit rester un seul joueur non Ã©liminÃ©.");
          return;
        }
        const winner = players.find(p => !eliminatedOrder.includes(p.id));
        if (winner) eliminatedOrder.push(winner.id);
      }

      const barÃ¨me = baremes[players.length] || baremes[8];

      for (let i = 0; i < eliminatedOrder.length; i++) {
        const playerId = eliminatedOrder[i];
        const points = barÃ¨me[i] !== undefined ? barÃ¨me[i] : 0;

        await supabase.from("eliminations").insert({
          player_id: playerId,
          terrain: currentTerrain,
          rank: i + 1
        });

        const { data } = await supabase.from("players").select("*").eq("id", playerId).single();
        if (data) {
          await supabase.from("players").update({
            total_points: data.total_points + points,
            matches: data.matches + 1
          }).eq("id", playerId);
        }
      }

      alert("âœ… Manche enregistrÃ©e !");
      players = [];
      eliminatedOrder = [];
      renderPlayers();
    }

    window.onload = () => {
      const t = document.getElementById("terrain");
      const p = document.getElementById("phase");
      const r = document.getElementById("round");
      for (let i = 1; i <= 5; i++) {
        t.innerHTML += `<option value="${i}">Piste ${i}</option>`;
        p.innerHTML += `<option value="${i}">Phase ${i}</option>`;
      }
      // Ajout de la demi-finale (phase 99)
      p.innerHTML += `<option value="99">Demi-finale</option>`;
      // Ajout de la finale manuelle (phase "finale")
      p.innerHTML += `<option value="finale">Finale manuelle</option>`;
      // Ajout du round C
      r.innerHTML += `<option value="C">C</option>`;
      // Ajout du round FM pour la finale manuelle
      r.innerHTML += `<option value="FM">FM</option>`;
    };

    window.chargerJoueurs = chargerJoueurs;
    window.validerManche = validerManche;
  </script>
</head>
<body>
  <header>
    <img src="../assets/FingerGame_logo_blanc_tagline.png" alt="Finger Game" />
    <h1>ðŸŽ¯ Arbitrage â€“ Finger Game</h1>
  </header>

  <label>Phase :</label>
  <select id="phase"></select>
  <label>Round :</label>
  <select id="round">
    <option value="A">A</option>
    <option value="B">B</option>
    <option value="F">F</option>
    <!-- Le round C et FM seront ajoutÃ©s dynamiquement -->
  </select>
  <label>Piste :</label>
  <select id="terrain"></select>
  <button onclick="chargerJoueurs()">Charger les joueurs</button>

  <div id="joueurs" style="margin-top: 20px;"></div>
  <p id="ordre"></p>

  <button onclick="validerManche()">âœ… Valider la Partie
