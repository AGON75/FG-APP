<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Finger Game â€“ Arbitre</title>
  <link rel="stylesheet" href="../css/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
  <h2>Arbitre â€“ SÃ©lection des joueurs</h2>

  <label for="terrain">NumÃ©ro du terrain :</label>
  <input type="number" id="terrain" min="1" required />
  <br /><br />

  <div class="grid" id="player-cards"></div>
  <button id="start-game" disabled>DÃ©marrer la partie (0/10)</button>

  <div id="game-area" style="display:none;">
    <h3>Manche en cours</h3>
    <ul id="player-list"></ul>
    <button id="next-round">Passer une manche sans Ã©limination</button>
    <button id="reset-game">RÃ©initialiser la partie</button>
  </div>

  <script>
    const SUPABASE_URL = "https://ckolzmqarfizoxjgolft.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrb2x6bXFhcmZpem94amdvbGZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2Nzg3NTYsImV4cCI6MjA2NTI1NDc1Nn0.ZlpERz1uznM0fn--GR9YgM2vjwe_kw-qiPF8KHJvMpI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const playerCardsContainer = document.getElementById("player-cards");
    const startGameBtn = document.getElementById("start-game");
    const terrainInput = document.getElementById("terrain");
    const playerList = document.getElementById("player-list");

    let selectedPlayers = [];
    let terrainNum = null;
    let rank = 1;

    async function loadPlayers() {
      const { data, error } = await supabase.from("players").select("*");
      if (error) {
        alert("Erreur chargement joueurs");
        return;
      }
      data.forEach(player => {
        const card = document.createElement("div");
        card.className = "card";
        card.dataset.id = player.id;
        card.dataset.name = player.name;
        card.innerText = player.name;
        card.addEventListener("click", () => toggleSelection(card));
        playerCardsContainer.appendChild(card);
      });
    }

    function toggleSelection(card) {
      const id = card.dataset.id;
      if (card.classList.contains("selected")) {
        card.classList.remove("selected");
        selectedPlayers = selectedPlayers.filter(p => p.id !== id);
      } else {
        if (selectedPlayers.length >= 10) return;
        card.classList.add("selected");
        selectedPlayers.push({ id, name: card.dataset.name });
      }
      updateButtonState();
    }

    function updateButtonState() {
      startGameBtn.innerText = `DÃ©marrer la partie (${selectedPlayers.length}/10)`;
      startGameBtn.disabled = selectedPlayers.length < 2 || selectedPlayers.length > 10;
    }

    startGameBtn.addEventListener("click", async () => {
      if (!terrainInput.value || selectedPlayers.length < 2) return;
      terrainNum = parseInt(terrainInput.value);
      document.getElementById("game-area").style.display = "block";
      document.getElementById("start-game").style.display = "none";
      document.getElementById("player-cards").style.display = "none";
      terrainInput.disabled = true;

      playerList.innerHTML = "";

      for (const player of selectedPlayers) {
        const { data } = await supabase
          .from("players")
          .select("name")
          .eq("id", player.id)
          .single();

        const li = document.createElement("li");
        li.innerText = `${data?.name || "Joueur inconnu"} â€“ ID: ${player.id}`;
        li.dataset.id = player.id;
        li.addEventListener("click", () => eliminate(player.id, li));
        playerList.appendChild(li);
      }
    });

    document.getElementById("next-round").addEventListener("click", () => {
      alert("Manche passÃ©e sans Ã©limination.");
    });

    document.getElementById("reset-game").addEventListener("click", () => {
      location.reload();
    });

    async function eliminate(id, element) {
      if (!confirm(`Ã‰liminer ce joueur ?`)) return;
      await supabase.from("eliminations").insert([{ player_id: id, terrain: terrainNum, rank }]);

      const { data: playerData } = await supabase.from("players").select("*").eq("id", id).single();
      const newPoints = (playerData?.total_points || 0) + rank;
      const newMatches = (playerData?.matches || 0) + 1;

      await supabase.from("players").update({
        total_points: newPoints,
        matches: newMatches
      }).eq("id", id);

      element.style.textDecoration = "line-through";
      element.style.opacity = 0.5;
      element.removeEventListener("click", () => eliminate(id, element));
      rank++;

      if (rank > selectedPlayers.length) {
        alert("ðŸŽ‰ Partie terminÃ©e !");
        location.reload();
      }
    }

    loadPlayers();
  </script>
</body>
</html>

