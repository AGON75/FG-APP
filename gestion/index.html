
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Gestion Joueurs</title>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://ckolzmqarfizoxjgolft.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrb2x6bXFhcmZpem94amdvbGZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2Nzg3NTYsImV4cCI6MjA2NTI1NDc1Nn0.ZlpERz1uznM0fn--GR9YgM2vjwe_kw-qiPF8KHJvMpI'
    );

    async function chargerJoueurs() {
      const { data } = await supabase.from("players").select("*").order("name", { ascending: true });
      const tableau = document.getElementById("joueurs");
      tableau.innerHTML = "";
      data.forEach(j => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${j.name}</td>
                        <td>${j.total_points}</td>
                        <td>${j.matches}</td>
                        <td><button onclick="supprimerJoueur('${j.id}')">âŒ</button></td>`;
        tableau.appendChild(tr);
      });
    }

    async function ajouterJoueur() {
      const nom = document.getElementById("nom").value;
      if (!nom) return alert("Nom requis");

      const { data: allPlayers } = await supabase.from("players").select("name");
      const usedNumbers = new Set();
      allPlayers.forEach(p => {
        const match = p.name.match(/#(\d+)/);
        if (match) usedNumbers.add(parseInt(match[1]));
      });

      let assigned = null;
      for (let i = 1; i <= 120; i++) {
        if (!usedNumbers.has(i)) {
          assigned = i;
          break;
        }
      }

      const nomComplet = `${nom} #${assigned || Math.floor(Math.random() * 1000)}`;
      await supabase.from("players").insert({ name: nomComplet });
      chargerJoueurs();
    }

    async function supprimerJoueur(id) {
      await supabase.from("eliminations").delete().eq("player_id", id);
      await supabase.from("players").delete().eq("id", id);
      chargerJoueurs();
    }

    async function resetTournoi() {
      if (!confirm("Remettre tous les points, terrains et manches Ã  0 ?")) return;
      await supabase.from("eliminations").delete().neq("id", "");
      await supabase.from("players").update({
        total_points: 0,
        matches: 0,
        terrain: null,
        phase: null,
        round: null
      }).neq("id", "");
      chargerJoueurs();
    }

    async function supprimerTousJoueurs() {
      if (!confirm("Supprimer tous les joueurs ?")) return;
      await supabase.from("eliminations").delete().neq("id", "");
      await supabase.from("players").delete().neq("id", "");
      chargerJoueurs();
    }

    window.onload = chargerJoueurs;
    window.ajouterJoueur = ajouterJoueur;
    window.supprimerJoueur = supprimerJoueur;
    window.resetTournoi = resetTournoi;
    window.supprimerTousJoueurs = supprimerTousJoueurs;
  </script>
</head>
<body>
  <h1>Gestion des joueurs</h1>

  <input id="nom" placeholder="Nom PrÃ©nom" />
  <button onclick="ajouterJoueur()">â• Ajouter</button>
  <button onclick="resetTournoi()">â™»ï¸ RÃ©initialiser le tournoi</button>
  <button onclick="supprimerTousJoueurs()">ğŸ”¥ Supprimer tous les joueurs</button>

  <table border="1" style="margin-top:20px;">
    <thead><tr><th>Nom</th><th>Points</th><th>Parties</th><th>Suppr.</th></tr></thead>
    <tbody id="joueurs"></tbody>
  </table>
</body>
</html>
